# Dockerfile

## PrÃ©sentation du Dockerfile

---

ğŸ”— [Documentation officielle - Dockerfile reference](https://docs.docker.com/reference/dockerfile/)

Un Dockerfile est un fichier texte qui contient une sÃ©rie d'instructions permettant de crÃ©er une image Docker de maniÃ¨re automatisÃ©e et reproductible. Il sert de plan de construction pour dÃ©finir l'environnement, les dÃ©pendances et les configurations nÃ©cessaires Ã  l'exÃ©cution d'une application.

De cette maniÃ¨re vous pouvez crÃ©er des images Docker personnalisÃ©es, pour rÃ©pondre Ã  un besoin spÃ©cifique.

Le fichier `Dockerfile` se trouve gÃ©nÃ©ralement Ã  la racine de votre projet. Le document suivant illustrera la construction dâ€™un Dockerfile pour une application Next.js.

## Lâ€™image de base

---

En premier lieu, il est nÃ©cessaire de spÃ©cifier lâ€™environnement que lâ€™on souhaite utiliser comme base. Lâ€™image de base va dÃ©finir cet environnement, incluant les dÃ©pendances et les composants nÃ©cessaires Ã  son fonctionnement. Lâ€™installation de ces composants est dÃ©jÃ  prise en charge par lâ€™image de base, vous nâ€™avez donc rien Ã  faire de ce cÃ´tÃ©.

Une application Next.js nÃ©cessite un environnement Node.js. Lâ€™image de base devra donc Ãªtre une image de Node.js. Ces images sont disponibles sur [Docker Hub](https://hub.docker.com/), un registre oÃ¹ vous pouvez chercher et tÃ©lÃ©charger des environnements prÃ©-configurÃ©s adaptÃ©s Ã  vos besoins.

```docker
FROM node:24-alpine3.21
```

Bien que vous puissiez crÃ©er un conteneur directement Ã  partir de cette image, celui-ci serait vide et inutilisable sans y ajouter vos fichiers et configurations.

## Configuration applicatif

---

Le Dockerfile est un script exÃ©cutÃ© par Docker. Il est donc nÃ©cessaire dâ€™indiquer les commandes Ã  exÃ©cuter pour configurer lâ€™environnement crÃ©Ã© par lâ€™image. Cette partie est propre Ã  la nature de votre projet, ici nous continuerons avec lâ€™exemple du Dockerfile pour une application Next.js.

Dans un premier temps, il est nÃ©cessaire de crÃ©er un dossier `app` dans le container pour lâ€™utiliser comme dossier de travail :

```docker
WORKDIR /app
```

Lâ€™exploitation de lâ€™application Next.js nÃ©cessite lâ€™installation des dÃ©pendances listÃ©es dans les fichiers `package.json` et `package-lock.json`. Pour que ces dÃ©pendances soient installÃ©es dans le container, il est nÃ©cessaire de copier ces deux fichiers dans le container puis de lancer lâ€™installation des dÃ©pendances.

La commande suivante crÃ©e une copie dans le dossier racine du container (le dossier `app` crÃ©Ã© prÃ©cÃ©demment) :

```docker
COPY package*.json ./

RUN npm install
```

Puis il sera nÃ©cessaire de copier le reste du projet dans le container :

```docker
COPY . .
```

Il est dorÃ©navant possible de construire lâ€™application Next.js au sein du container pour un futur dÃ©marrage  :

```docker
RUN npm run build
```

**RÃ©capitulatif des actions listÃ©es dans le Dockerfile :**


1. Utiliser lâ€™image Node comme base.

2. CrÃ©er un dossier `app` dans le container et lâ€™utiliser comme dossier racine.

3. Copier les fichiers `package.json` et `package-lock.json` dans le container.

4. ExÃ©cuter lâ€™installation des librairies.

5. Copier le reste du projet dans le container.

6. Construire le projet Next.js.

## **Rendre lâ€™application accessible**

---

Lâ€™environnement du container ainsi que celui de lâ€™application sont en place. Il ne reste plus quâ€™Ã  dÃ©marrer lâ€™application Next.js et lâ€™exposer.

Les services exploitÃ©s par Docker utilisent les mÃªmes ports que ceux des services de votre machine (par exemple, Next.js utilise le port 3000 sur votre machine, Next.js fait de mÃªme dans son container Docker). Pour mapper le port 3000 du container Ã  celui de votre machine, il est nÃ©cessaire dâ€™indiquer le port Ã  exposer dans le script Dockerfile.

La commande suivante va exposer le port 3000 du container pour quâ€™il puisse Ãªtre mappÃ© sur celui de votre machine, rendant lâ€™application exÃ©cutÃ©e dans le container consultable :

```docker
EXPOSE 3000
```

Il ne manque plus quâ€™une chose pour que la magie opÃ¨re : la commande de dÃ©marrage du projet ! La commande suivante va indiquer Ã  Docker quelle commande il doit exÃ©cuter lorsque le container dÃ©marre, câ€™est-Ã -dire lorsquâ€™il a fini dâ€™exÃ©cuter le script.

```docker
CMD ["npm", "run", "dev"]
```

## Exemple Dockerfile Next.js

---

```docker
FROM node:24-alpine3.21

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

RUN npm run build

EXPOSE 3000

CMD ["npm", "run", "dev"]
```

## CrÃ©er et exÃ©cuter un container

---

Voir [Commandes Docker](https://www.notion.so/Commandes-Docker-1942080267e580cf9fe2ca889fa99713?pvs=21) pour une liste des commandes ainsi que des explications supplÃ©mentaires Docker disponibles

Dans un terminal, Ã  la racine du votre projet, lÃ  oÃ¹ se trouve le Dockerfile, exÃ©cuter la commande suivante pour construire votre image.

```bash
docker build -t <nom_pour_votre_image> .
```

Lâ€™image est construite, exÃ©cutez la commande suivante pour dÃ©marrer un container basÃ© sur lâ€™image : 

```bash
docker run -p 3000:3000 <nom_de_votre_image_cree_precedemment>
```

Vous devriez avoir accÃ¨s Ã  votre application Next.js Ã  lâ€™URL suivante ğŸ”—[http://localhost:3000](http://localhost:3000).

## Les volumes

---

Les volumes permettent de persister et de partager des donnÃ©es entre le systÃ¨me hÃ´te (votre machine) et les containers, ou entre diffÃ©rents containers. Câ€™est ce dont vous avez besoin pour  que le container prÃ©cÃ©demment crÃ©Ã© exploite les fichiers de lâ€™application Next.js local et ainsi appliquer les changements en direct.

La commande suivante est la mÃªme quâ€™utilisÃ© prÃ©cÃ©demment pour lancer le container mais le paramÃ¨tre `-v <chemin_du_contenu_a_persister>:/app` demande la crÃ©ation dâ€™un volume avec le contenu que vous souhaitez persister dans le rÃ©pertoire de travail du container.

Le `$(pwd):/app` permet dâ€™indiquer la source et la destination de la persistance. Ici `$(pwd)` correspondant Ã  tout le contenu du dossier oÃ¹ vous vous trouver, et que vous souhaitez persister dans le dossier `/app` du container.

```bash
docker run -p 3000:3000 -v $(pwd):/app <nom_de_votre_image_cree_precedemment>
```