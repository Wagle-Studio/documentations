## Introduction

---

üîó [Exemples de VirtualHost - Apache](https://httpd.apache.org/docs/2.2/fr/vhosts/examples.html)

Les Virtual Hosts sont au c≈ìur de la configuration d‚ÄôApache lorsqu‚Äôil s‚Äôagit d‚Äôh√©berger plusieurs sites sur un m√™me serveur.

Ils permettent de d√©finir des environnements ind√©pendants, chacun avec son propre nom de domaine, son dossier racine et ses logs, tout en partageant la m√™me instance Apache.

Cette approche est indispensable pour organiser proprement plusieurs projets web, que ce soit sur un serveur de production ou en environnement local de d√©veloppement.

Chaque virtual host correspond √† une configuration distincte stock√©e dans le dossier `/etc/apache2/sites-available`, puis activ√©e pour √™tre lue par Apache.

## Sites disponibles et sites actifs

---

Les dossiers `/etc/apache2/sites-available` et `/etc/apache2/sites-enabled` ont un r√¥le important √† conna√Ætre.

### Sites disponibles

---

`/etc/apache2/sites-available`

Ce dossier contient l‚Äôensemble des fichiers de configuration des virtual hosts disponibles sur le serveur.

Chaque fichier y d√©finit les param√®tres d‚Äôun site web (nom de domaine, dossier racine, logs, etc.).

Les fichiers pr√©sents ici ne sont pas encore actifs tant qu‚Äôils n‚Äôont pas √©t√© explicitement activ√©s.

### Sites actifs

---

`/etc/apache2/sites-enabled`

Ce dossier contient uniquement des liens symboliques pointant vers les fichiers de configuration pr√©sents dans `sites-available`.

Lorsqu‚Äôun site est activ√© avec la commande `a2ensite nom_du_site.conf`, Apache cr√©e automatiquement ce lien symbolique, rendant ainsi le site actif et charg√© au prochain red√©marrage du service.

Par d√©faut, Apache installe des fichiers de configuration de base comme `000-default.conf` et `default-ssl.conf`. Ces fichiers peuvent servir d‚Äôexemples, mais il est recommand√© de les d√©sactiver pour √©viter les conflits avec vos propres configurations.

```bash
sudo a2dissite 000-default.conf # d√©sactive 000-default.conf (HTTP port 80)
sudo a2dissite default-ssl.conf # d√©sactive default-ssl.conf (HTTPS port 443)
```

## Cr√©er un virtual host

---

Pour h√©berger un site avec Apache, vous devez cr√©er un virtual host, c‚Äôest-√†-dire un fichier de configuration d√©di√© √† ce site.

Chaque virtual host d√©finit les r√®gles propres √† un projet : domaine, dossier racine, logs et droits d‚Äôacc√®s.

Cr√©ez ce fichier dans le dossier `/etc/apache2/sites-available/`.

Choisissez un nom clair et explicite pour le retrouver facilement, par exemple : `mon_site_dev.conf` pour un environnement de d√©veloppement ou `mon_site_prod.conf` pour la production.

```bash
sudo nano /etc/apache2/sites-available/<mon_site>.conf # √† compl√©ter
sudo nano /etc/apache2/sites-available/my_project_dev.conf # exemple
```

### Exemple g√©n√©rique

---

Un virtual host se compose d‚Äôun bloc `<VirtualHost>` qui d√©finit comment Apache doit r√©pondre √† un domaine donn√©.

Chaque bloc pr√©cise le port, le domaine, les logs, les permissions, et la mani√®re dont le contenu est servi (fichiers statiques ou proxy vers une application).

```txt
<VirtualHost *:80>
    ServerName mon-site.fr
    ServerAlias www.mon-site.fr

    ErrorLog ${APACHE_LOG_DIR}/mon_site_error.log
    CustomLog ${APACHE_LOG_DIR}/mon_site_access.log combined
</VirtualHost>
```

- `ServerName` : nom de domaine principal du site  

- `ServerAlias` : variantes du domaine principal  

- `ErrorLog` et `CustomLog` : fichiers de logs d√©di√©s √† ce site  

### Servir un site statique

---

Dans le cas d‚Äôun site statique, Apache distribue directement les fichiers pr√©sents dans un dossier local du serveur.

```txt
<VirtualHost *:80>
    ServerName my-static-site.fr
    ServerAlias www.my-static-site.fr

    DocumentRoot /var/www/my_static_site

    <Directory /var/www/my_static_site>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/my_static_site_error.log
    CustomLog ${APACHE_LOG_DIR}/my_static_site_access.log combined
</VirtualHost>
```

- `DocumentRoot` : dossier racine du site  

- `Directory` : permissions et comportements appliqu√©s √† ce dossier  
  
  - `Options` `Indexes` `FollowSymLinks` : autorise la navigation dans le r√©pertoire et les liens symboliques  
  
  - `AllowOverride All` : permet aux fichiers `.htaccess` d‚Äôappliquer leurs propres r√®gles  
  
  - `Require all granted` : autorise l‚Äôacc√®s √† tous les visiteurs  

Ce mode est id√©al pour des sites statiques, des portfolios ou des exports HTML simples.

### Servir une application via reverse proxy

---

Un reverse proxy publie une application qui √©coute sur une URL locale avec un port. C‚Äôest le cas pour les applications Node.js ou tout autre serveur web applicatif.

Avant tout, il faut activer les modules n√©cessaires :

```bash
sudo a2enmod proxy proxy_http proxy_wstunnel headers
sudo systemctl restart apache2
```

Exemple complet pour une application qui tourne sur le port `4174` :

```txt
<VirtualHost *:80>
    ServerName my-app-dev.fr
    ServerAlias www.my-app-dev.fr

    ProxyPreserveHost On

    # redirection du trafic HTTP vers l'app
    ProxyPass        / http://localhost:4174/ retry=0
    ProxyPassReverse / http://localhost:4174/

    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ErrorLog ${APACHE_LOG_DIR}/my_app_error.log
    CustomLog ${APACHE_LOG_DIR}/my_app_access.log combined
</VirtualHost>
```

Ce mode permet de faire transiter les requ√™tes vers une application locale sans exposer directement son port.

### Variante mixte dossier et proxy

---

Il est aussi possible de combiner un dossier statique (pour les ressources publiques) et un proxy pour l‚Äôapplication.

```txt
<VirtualHost *:80>
    ServerName my-project-dev.fr

    DocumentRoot /var/www/my_project

    <Directory /var/www/my_project>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ProxyPreserveHost On

    # ne proxifie pas le sous-dossier public
    ProxyPass        /public !
    ProxyPass        / http://localhost:4174/ retry=0
    ProxyPassReverse / http://localhost:4174/

    ErrorLog ${APACHE_LOG_DIR}/my_project_error.log
    CustomLog ${APACHE_LOG_DIR}/my_project_access.log combined
</VirtualHost>
```

Ce type de configuration est souvent utilis√© pour des applications modernes dont les assets statiques sont servis par Apache, tandis que le rendu dynamique passe par un serveur applicatif.

## Activer un virtual host

---

Une fois le fichier de configuration cr√©√©, vous devez l‚Äôactiver pour qu‚ÄôApache le prenne en compte.

```bash
sudo a2ensite <mon_site>.conf # √† compl√©ter
sudo a2ensite my_project_dev.conf # exemple
sudo systemctl reload apache2 # recharge la configuration sans couper le service
```

Cette commande cr√©e un lien symbolique entre le fichier `/etc/apache2/sites-available/my_project_dev.conf` et le dossier `/etc/apache2/sites-enabled`.

Apache lit ensuite ce dossier pour charger uniquement les sites activ√©s.

Le site est donc d√©sormais disponible.

## Nom de domaine

---

Chaque virtual host doit √™tre identifi√© par un nom unique pour qu‚ÄôApache sache quelle configuration utiliser lorsqu‚Äôil re√ßoit une requ√™te.

Ce r√¥le est assur√© par les directives `ServerName` et `ServerAlias`.

- ServerName indique le nom de domaine principal du site, c‚Äôest celui que le client (navigateur) enverra dans l‚Äôen-t√™te `Host` de la requ√™te HTTP  

- ServerAlias permet de d√©finir des variantes de ce nom, comme les versions avec ou sans `www`  

Lorsque le navigateur envoie une requ√™te √† Apache, celui-ci compare le nom re√ßu dans l‚Äôen-t√™te `Host` avec les valeurs de `ServerName` et `ServerAlias` de chaque virtual host.

C‚Äôest ainsi qu‚Äôil d√©termine quelle configuration charger et donc quel site servir.

Si aucun `ServerName` ou `ServerAlias` ne correspond, Apache utilisera le premier virtual host d√©fini (souvent `000-default.conf`).

Cela peut entra√Æner l‚Äôaffichage du mauvais site, ou simplement la page par d√©faut d‚ÄôApache.
