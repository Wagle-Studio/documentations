## Introduction

---

ðŸ”— [Documentation .htpasswd - Apache officiel](https://httpd.apache.org/docs/2.4/fr/programs/htpasswd.html)

Il existe plusieurs faÃ§ons de restreindre lâ€™accÃ¨s Ã  un site distribuÃ© par Apache. La mÃ©thode la plus simple consiste Ã  utiliser un fichier `.htpasswd`.

Une fois en place, lâ€™accÃ¨s au site nÃ©cessite la saisie dâ€™identifiants valides. Cette solution est adaptÃ©e Ã  une instance de prÃ©-production ou Ã  un site interne.

## Mise en place du fichier .htpasswd

---

Mettre en place cette restriction consiste Ã  stocker une combinaison identifiant + mot de passe dans un fichier .htpasswd, stockÃ© dans le dossier /etc/apache2.

GÃ©nÃ©rez le fichier et un premier utilisateur avec la commande suivante :

```bash
# Ã  complÃ©ter
sudo htpasswd -c /etc/apache2/.<nom_du_htpasswd> <mon_utilisateur>

# exemple
sudo htpasswd -c /etc/apache2/.my_project kevin 
```

Pour ajouter un nouvel utilisateur sans recrÃ©er le fichier :

```bash
sudo htpasswd /etc/apache2/.<nom_du_htpasswd_existant> <autre_utilisateur>
```

Si vous prÃ©fÃ¨rez organiser plusieurs fichiers de mots de passe, crÃ©e un dossier et place-y vos fichiers :

```bash
sudo mkdir -p /etc/apache2/sites-htpasswd # vous Ãªtes libres de nommer ce dossier

# Ã  complÃ©ter : crÃ©ation d'un htpasswd dans un dossier personnalisÃ©
sudo htpasswd -c /etc/apache2/<votre_dossier>/.<nom_du_htpasswd> <mon_utilisateur>

# exemple
sudo htpasswd -c /etc/apache2/sites-htpasswd/.my_project kevin
```

## Configuration du virtual host

---

Ajoutez les directives dâ€™authentification dans le virtual host, dans un bloc `<Directory>` ou `<Location>` selon le pÃ©rimÃ¨tre Ã  protÃ©ger.

N'oubliez pas de retirer `Require all granted`, qui entrerait en conflit avec `Require valid-user`.

```txt
<VirtualHost *:443>  
    ServerName my-project-dev.fr 
    ServerAlias www.my-project-dev.fr
    DocumentRoot /var/www/my_project

    <Directory /var/www/my_project>  
        Options Indexes FollowSymLinks  
        AllowOverride All  

        AuthType Basic  
        AuthName "Restricted access"  
        AuthUserFile /etc/apache2/sites-htpasswd/.my_project  
        Require valid-user  
    </Directory>  

    ErrorLog ${APACHE_LOG_DIR}/my_project_error.log  
    CustomLog ${APACHE_LOG_DIR}/my_project_access.log combined  
</VirtualHost>
```

- `AuthType Basic` spÃ©cifie l'utilisation de l'authentification basique.

- `AuthName` est le message affichÃ© dans la fenÃªtre d'authentification.

- `AuthUserFile` indique le chemin vers votre fichier `.htpasswd`.

- `Require valid-user` autorise uniquement les utilisateurs valides.

Ensuite, testez votre configuration :

```bash
sudo apache2ctl configtest
```

RedÃ©marrez Apache pour appliquer les changements :

```bash
sudo systemctl restart apache2
```

DÃ¨s lors, le site nâ€™est plus chargÃ© jusquâ€™Ã  ce que lâ€™utilisateur saisisse la combinaison identifiant + mot de passe dans la popup affichÃ©es Ã  lâ€™ouverture de la page.

## .htpasswd et protocole HTTPS

---

Si vous avez des configurations distinctes pour HTTP et HTTPS (un fichier de configuration Ã©coutant sur le port 80 pour HTTP et un autre Ã©coutant sur le port 443 pour HTTPS), assurez-vous de nâ€™implÃ©menter la demande dâ€™authentification simple que dans le fichier de configuration HTTPS.

Le fichier de configuration HTTP sert uniquement Ã  rediriger automatiquement les utilisateurs vers HTTPS, et il nâ€™est pas nÃ©cessaire de le sÃ©curiser par un mot de passe, puisqu'il n'est pas accessible directement. Vous voulez restreindre lâ€™accÃ¨s seulement sur la version HTTPS.

## Gestion de plusieurs .htpasswd

---

Le nom du fichier htpasswd importe peu. C'est le chemin vers ce fichier, dÃ©clarÃ© dans `AuthUserFile` du virtual host qui est important.

Vous Ãªtes libre d'organiser et de crÃ©er vos fichiers htpasswd comme vous le souhaitez.

L'essentiel est de dÃ©clarer le chemin vers le fichier htpasswd dÃ©sirÃ© dans les virtual host appropriÃ©.

```bash
etc/
â”œâ”€ apache2/
â”‚  â”œâ”€ sites-available/
â”‚  â”‚  â”œâ”€ my_project.conf
â”‚  â”‚  â”œâ”€ my_other_project.conf
â”‚  â”‚
â”‚  â”œâ”€ sites-enabled/
â”‚  â”‚
â”‚  â”œâ”€ sites-htpasswd/
â”‚  â”‚  â”œâ”€ .my_project
â”‚  â”‚  â”œâ”€ .my_other_project
```