## Introduction

---

ğŸ”— [Exemples de VirtualHost - Apache](https://httpd.apache.org/docs/2.2/fr/vhosts/examples.html)

Les Virtual Hosts sont au cÅ“ur de la configuration dâ€™Apache lorsquâ€™il sâ€™agit dâ€™hÃ©berger plusieurs sites sur un mÃªme serveur.

Ils permettent de dÃ©finir des environnements indÃ©pendants, chacun avec son propre nom de domaine, son dossier racine et ses logs, tout en partageant la mÃªme instance Apache.

Cette approche est indispensable pour organiser proprement plusieurs projets web, que ce soit sur un serveur de production ou en environnement local de dÃ©veloppement.

Chaque virtual host correspond Ã  une configuration distincte stockÃ©e dans le dossier `/etc/apache2/sites-available`, puis activÃ©e pour Ãªtre lue par Apache.

## Sites disponibles et sites actifs

---

Les dossiers `/etc/apache2/sites-available` et `/etc/apache2/sites-enabled` ont un rÃ´le important Ã  connaÃ®tre.

### Sites disponibles

---

`/etc/apache2/sites-available`

Ce dossier contient lâ€™ensemble des fichiers de configuration des virtual hosts disponibles sur le serveur.

Chaque fichier y dÃ©finit les paramÃ¨tres dâ€™un site web (nom de domaine, dossier racine, logs, etc.).

Les fichiers prÃ©sents ici ne sont pas encore actifs tant quâ€™ils nâ€™ont pas Ã©tÃ© explicitement activÃ©s.

### Sites actifs

---

`/etc/apache2/sites-enabled`

Ce dossier contient uniquement des liens symboliques pointant vers les fichiers de configuration prÃ©sents dans `sites-available`.

Lorsquâ€™un site est activÃ© avec la commande `a2ensite nom_du_site.conf`, Apache crÃ©e automatiquement ce lien symbolique, rendant ainsi le site actif et chargÃ© au prochain redÃ©marrage du service.

Par dÃ©faut, Apache installe des fichiers de configuration de base comme `000-default.conf` et `default-ssl.conf`. Ces fichiers peuvent servir dâ€™exemples, mais il est recommandÃ© de les dÃ©sactiver pour Ã©viter les conflits avec vos propres configurations.

```bash
sudo a2dissite 000-default.conf # dÃ©sactive 000-default.conf (HTTP port 80)
sudo a2dissite default-ssl.conf # dÃ©sactive default-ssl.conf (HTTPS port 443)
```

## CrÃ©er un virtual host

---

Pour hÃ©berger un site avec Apache, vous devez crÃ©er un virtual host, câ€™est-Ã -dire un fichier de configuration dÃ©diÃ© Ã  ce site.

Chaque virtual host dÃ©finit les rÃ¨gles propres Ã  un projet : domaine, dossier racine, logs et droits dâ€™accÃ¨s.

CrÃ©ez ce fichier dans le dossier `/etc/apache2/sites-available/`.

Choisissez un nom clair et explicite pour le retrouver facilement, par exemple : `mon_site_dev.conf` pour un environnement de dÃ©veloppement ou `mon_site_prod.conf` pour la production.

```bash
sudo nano /etc/apache2/sites-available/<mon_site>.conf # Ã  complÃ©ter
sudo nano /etc/apache2/sites-available/my_project_dev.conf # exemple
```

Voici un exemple de configuration simple pour le site web my-project-dev.fr servi sur le port 80 (HTTP) :

```txt
<VirtualHost *:80>
    ServerName my-project-dev.fr
    ServerAlias www.my-project-dev.fr
    DocumentRoot /var/www/my_project

    <Directory /var/www/my_project>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/my_project_error.log
    CustomLog ${APACHE_LOG_DIR}/my_project_access.log combined
</VirtualHost>
```

- `ServerName` : indique le domaine principal, cela peut Ãªtre un nom de domaine ou une adresse IP.

- `ServerAlias` : variantes du domaine principal.

- `DocumentRoot` : spÃ©cifie le dossier racine du site.

- `Directory` : dÃ©finit les rÃ¨gles dâ€™accÃ¨s pour le dossier spÃ©cifiÃ©. Dans cet exemple :

  - `Options` `Indexes` `FollowSymLinks` : autorise la navigation dans le rÃ©pertoire et le suivi des liens symboliques.

  - `AllowOverride All` : permet aux fichiers .htaccess dâ€™appliquer leurs propres rÃ¨gles.

  - `Require all granted` : autorise lâ€™accÃ¨s Ã  tous les utilisateurs.

- `Log files` : dÃ©finissent oÃ¹ enregistrer les erreurs et les logs dâ€™accÃ¨s pour ce site.

## Activer un virtual host

---

Une fois le fichier de configuration crÃ©Ã©, vous devez lâ€™activer pour quâ€™Apache le prenne en compte.

Activez le virtual host, puis redÃ©marrez le service Apache :

```bash
sudo a2ensite <mon_site>.conf # Ã  complÃ©ter
sudo a2ensite my_project_dev.conf # exemple

sudo systemctl reload apache2 # recharge la configuration sans couper le service
```

Cette commande crÃ©e un lien symbolique entre le fichier `/etc/apache2/sites-available/my_project_dev.conf` et le dossier `/etc/apache2/sites-enabled`.

Apache lit ensuite ce dossier pour charger uniquement les sites activÃ©s.

Le site est donc dÃ©sormais disponible.

## Nom de domaine

---

Chaque virtual host doit Ãªtre identifiÃ© par un nom unique pour quâ€™Apache sache quelle configuration utiliser lorsquâ€™il reÃ§oit une requÃªte.

Ce rÃ´le est assurÃ© par les directives `ServerName` et `ServerAlias`.

- ServerName indique le nom de domaine principal du site, câ€™est celui que le client (navigateur) enverra dans lâ€™en-tÃªte `Host` de la requÃªte HTTP.

- ServerAlias permet de dÃ©finir des variantes de ce nom, comme les versions avec ou sans `www`.

Lorsque le navigateur envoie une requÃªte Ã  Apache, celui-ci compare le nom reÃ§u dans lâ€™en-tÃªte `Host` avec les valeurs de `ServerName` et `ServerAlias` de chaque virtual host.

Câ€™est ainsi quâ€™il dÃ©termine quelle configuration charger et donc quel site servir.

Si aucun `ServerName` ou `ServerAlias` ne correspond, Apache utilisera le premier virtual host dÃ©fini (souvent `000-default.conf`).

Cela peut entraÃ®ner lâ€™affichage du mauvais site, ou simplement la page par dÃ©faut dâ€™Apache.
