## Introduction

---

ðŸ”— [Documentation .htpasswd - Apache](https://httpd.apache.org/docs/2.4/fr/programs/htpasswd.html)

Il existe plusieurs faÃ§ons de restreindre lâ€™accÃ¨s Ã  un site distribuÃ© par Apache. La mÃ©thode la plus simple consiste Ã  utiliser un fichier `.htpasswd`.

Une fois en place, lâ€™accÃ¨s au site nÃ©cessite la saisie dâ€™identifiants valides. Cette solution est adaptÃ©e Ã  une instance de prÃ©production ou Ã  un site interne.

## Mise en place du fichier .htpasswd

---

Mettre en place cette restriction consiste Ã  stocker une combinaison identifiant + mot de passe dans un fichier `.htpasswd`, situÃ© dans le dossier `/etc/apache2`.

GÃ©nÃ©rez le fichier et un premier utilisateur avec la commande suivante :

```bash
# Ã  complÃ©ter
sudo htpasswd -c /etc/apache2/.<nom_du_htpasswd> <mon_utilisateur>

# exemple
sudo htpasswd -c /etc/apache2/.my_project kevin
```

Pour ajouter un nouvel utilisateur sans recrÃ©er le fichier :

```bash
sudo htpasswd /etc/apache2/.<nom_du_htpasswd_existant> <autre_utilisateur>
```

Si vous prÃ©fÃ©rez organiser plusieurs fichiers de mots de passe, crÃ©ez un dossier et placez-y vos fichiers :

```bash
sudo mkdir -p /etc/apache2/sites-htpasswd # vous Ãªtes libre de nommer ce dossier

# Ã  complÃ©ter : crÃ©ation d'un htpasswd dans un dossier personnalisÃ©
sudo htpasswd -c /etc/apache2/<votre_dossier>/.<nom_du_htpasswd> <mon_utilisateur>

# exemple
sudo htpasswd -c /etc/apache2/sites-htpasswd/.my_project kevin
```

## Configuration du virtual host

---

Ajoutez les directives dâ€™authentification dans le virtual host, dans un bloc `<Directory>` ou `<Location>` selon le pÃ©rimÃ¨tre Ã  protÃ©ger.

N'oubliez pas de retirer `Require all granted`, qui entrerait en conflit avec `Require valid-user`.

### Exemple avec site statique

---

```txt
<VirtualHost *:80>
    ServerName my-static-site.fr
    ServerAlias www.my-static-site.fr

    DocumentRoot /var/www/my_static_site

    <Directory /var/www/my_static_site>
        Options Indexes FollowSymLinks
        AllowOverride All

        AuthType Basic
        AuthName "Restricted access"
        AuthUserFile /etc/apache2/sites-htpasswd/.my_static_site
        Require valid-user
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/my_static_site_error.log
    CustomLog ${APACHE_LOG_DIR}/my_static_site_access.log combined
</VirtualHost>
```

Ce bloc protÃ¨ge lâ€™ensemble du site statique. DÃ¨s que lâ€™utilisateur tente dâ€™y accÃ©der, une fenÃªtre dâ€™authentification sâ€™affiche.

### Exemple avec reverse proxy

---

```txt
<VirtualHost *:80>
    ServerName my-app-dev.fr
    ServerAlias www.my-app-dev.fr

    ProxyPreserveHost On

    <Location />
        AuthType Basic
        AuthName "Restricted access"
        AuthUserFile /etc/apache2/sites-htpasswd/.my_app
        Require valid-user
    </Location>

    ProxyPass        / http://localhost:4174/ retry=0
    ProxyPassReverse / http://localhost:4174/

    ProxyPass        /_next/webpack-hmr ws://localhost:4174/_next/webpack-hmr
    ProxyPassReverse /_next/webpack-hmr ws://localhost:4174/_next/webpack-hmr

    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ErrorLog ${APACHE_LOG_DIR}/my_app_error.log
    CustomLog ${APACHE_LOG_DIR}/my_app_access.log combined
</VirtualHost>
```

Ici, la restriction est appliquÃ©e au niveau du `<Location />`, ce qui bloque tout accÃ¨s au proxy tant que lâ€™utilisateur nâ€™a pas fourni dâ€™identifiants valides.

Cette configuration est idÃ©ale pour protÃ©ger une application Node.js ou autre application dynamique derriÃ¨re Apache.

### Exemple mixte (public et proxy protÃ©gÃ©)

---

```txt
<VirtualHost *:80>
    ServerName my-project-dev.fr

    DocumentRoot /var/www/my_project

    <Directory /var/www/my_project/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Location />
        AuthType Basic
        AuthName "Restricted area"
        AuthUserFile /etc/apache2/sites-htpasswd/.my_project
        Require valid-user
    </Location>

    ProxyPreserveHost On

    ProxyPass        /public !
    ProxyPass        / http://localhost:4174/ retry=0
    ProxyPassReverse / http://localhost:4174/

    ProxyPass        /_next/webpack-hmr ws://localhost:4174/_next/webpack-hmr
    ProxyPassReverse /_next/webpack-hmr ws://localhost:4174/_next/webpack-hmr

    ErrorLog ${APACHE_LOG_DIR}/my_project_error.log
    CustomLog ${APACHE_LOG_DIR}/my_project_access.log combined
</VirtualHost>
```

Dans cet exemple, seul le dossier `/public` reste libre dâ€™accÃ¨s. Tout le reste du site passe par le proxy et nÃ©cessite une authentification.

### VÃ©rification et redÃ©marrage

---

```bash
sudo apache2ctl configtest
sudo systemctl restart apache2
```

DÃ¨s lors, le site ou lâ€™application nâ€™est plus accessible sans identifiants.

## .htpasswd et protocole HTTPS

---

Si vous avez des configurations distinctes pour HTTP et HTTPS (un fichier de configuration Ã©coutant sur le port 80 pour HTTP et un autre Ã©coutant sur le port 443 pour HTTPS), assurez-vous dâ€™implÃ©menter la demande dâ€™authentification uniquement dans la configuration HTTPS.

Le fichier de configuration HTTP sert uniquement Ã  rediriger automatiquement les utilisateurs vers HTTPS. Il nâ€™est donc pas nÃ©cessaire de le sÃ©curiser par un mot de passe, puisqu'il nâ€™est pas accessible directement. Vous devez restreindre lâ€™accÃ¨s seulement sur la version HTTPS.

## Gestion de plusieurs .htpasswd

---

Le nom du fichier `.htpasswd` importe peu. Ce qui compte est le chemin vers ce fichier, dÃ©clarÃ© dans `AuthUserFile` du virtual host.

Vous Ãªtes libre dâ€™organiser et de crÃ©er vos fichiers `.htpasswd` comme vous le souhaitez.

Lâ€™essentiel est de dÃ©clarer le chemin vers le fichier dÃ©sirÃ© dans les virtual hosts appropriÃ©s.

```bash
etc/
â”œâ”€ apache2/
â”‚  â”œâ”€ sites-available/
â”‚  â”‚  â”œâ”€ my_project.conf
â”‚  â”‚  â”œâ”€ my_other_project.conf
â”‚  â”‚
â”‚  â”œâ”€ sites-enabled/
â”‚  â”‚
â”‚  â”œâ”€ sites-htpasswd/
â”‚  â”‚  â”œâ”€ .my_project
â”‚  â”‚  â”œâ”€ .my_other_project
```
