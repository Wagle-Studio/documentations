# Docker-compose

## Pr√©sentation de Docker-compose

---

Voir le document sur le fichier [Dockerfile](https://www.notion.so/Dockerfile-1942080267e5806d8738d4cd76215141?pvs=21) qui introduit certaines bases de Docker. Ici, nous allons approfondir avec des exemples de code issus de ce document.

Une application repose souvent sur plusieurs services : backend PHP, frontend JS, base de donn√©es SQL, serveur SMTP pour les emails, etc. Chaque service n√©cessite un container propre et cela peut devenir fastidieux.

Docker-compose est un outil permettant de d√©finir et g√©rer plusieurs conteneurs √† partir d‚Äôun fichier unique : `docker-compose.yml`. Plut√¥t que de lancer manuellement chaque service, tout est automatis√© et orchestr√© vie un unique fichier.

Ce fichier organisera les configurations des diff√©rentes images n√©cessaires au bon fonctionnement de l‚Äôenvironnement. Le document suivant illustrera la construction d‚Äôun environnement Docker-compose pour une application Next.js, le serveur de base de donn√©es MySQL et PHPMyAdmin.

Le fichier `docker-compose.yml` se trouve g√©n√©ralement √† la racine du projet contenant les diff√©rentes parties du projet complet.

```bash
my_project/
‚îú‚îÄ nextjs/
‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ
‚îú‚îÄ PHP/
‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ
‚îú‚îÄ caddy/
‚îú‚îÄ README.md
‚îú‚îÄ docker-compose.yml 
```

## Image en lecture seule

---

Contrairement aux images personnalis√©es, les images en lecture seule ne n√©cessitent pas de fichier Dockerfile. Elles doivent simplement recevoir quelques configurations pour √™tre pleinement exploitables "out of the box".

Ce fonctionnement est typique pour des images telles que les bases de donn√©es, les administrateurs de syst√®mes de gestion de bases de donn√©es (comme PHPMyAdmin), les applications de tests d‚Äôint√©gration, les intercepteurs d‚Äôemails, etc.

La plupart du temps, ces images mettent √† disposition des services qui gravitent autour de l‚Äôapplication principale, ici l‚Äôapplication Next.js cr√©√©e lors de la d√©couverte du [Dockerfile](https://www.notion.so/Dockerfile-1942080267e5806d8738d4cd76215141?pvs=21)  et des images custom.

### MySQL

---

Ajouter la configuration suivante dans le fichier `docker-compose.yml`.

```yaml
services:
  db:
    image: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: my_database
      MYSQL_USER: admin
      MYSQL_PASSWORD: root
    ports:
      - "3306:3306"
```

Le container est d√©clar√© avec le nom `db`, le nommage est libre. Ce nom sera celui du container dans le futur environnement. Ce container exploite l‚Äôimage `mysql` t√©l√©charg√©e sur [Docker Hub](https://hub.docker.com/).

Le port 3306 sera expos√© pour acc√©der au container.

| **Variable** | **Information** |
| --- | --- |
| `MYSQL_ROOT_PASSWORD` | Mot de passe de l‚Äôutilisateur root de MySQL. |
| `MYSQL_DATABASE` | Nom de la base de donn√©es souhait√©e. |
| `MYSQL_USER` | Nom de l‚Äôutilisateur de base de donn√©es souhait√©. |
| `MYSQL_PASSWORD` | Mot de passe de l‚Äôutilisateur de base de donn√©es souhait√©. |

Vous pouvez dors-et-d√©j√† ex√©cuter l‚Äôenvironnement pour tester le service MySQL. Rendez-vous au chapitre üìñ [Ex√©cuter l‚Äôenvironnement Docker-compose](https://www.notion.so/Docker-compose-1942080267e58003a8afd8f46a3a779a?pvs=21).

### PHPMyAdmin

---

Ajouter la configuration suivante dans le fichier `docker-compose.yml` (attention, code raccourcis).

```yaml
version: '3.8'

services:
  db:
    image: mysql
    ...

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      PMA_HOST: db
      PMA_USER: admin
      PMA_PASSWORD: root
    ports:
      - "8080:80"
```

Avec la d√©finition de ce nouveau container `phpmyadmin`, bas√© sur l‚Äôimage de PHPMyAdmin, un container PHPMyAdmin sera accessible sur le port 8080 et permettra d‚Äôadministrer la base de donn√©es cr√©√©e par le container `db`.

| **Variable** | **Information** |
| --- | --- |
| `PMA_HOST` | Le port de la base de donn√©es sur laquelle √©couter, ici on n‚Äôindique pas un port mais bien le nom du container `db` ex√©cutant la base de donn√©es MySQL. |
| `PMA_USER` | Nom de l‚Äôutilisateur de base de donn√©es exploit√© par PHPMyAdmin. |
| `PMA_PASSWORD` | Mot de passe de l‚Äôutilisateur de base de donn√©es exploit√© par PHPMyAdmin. |

## Image personnalis√©e

---

Ajouter la configuration suivante dans le fichier `docker-compose.yml` (pensez √† remplacer le nom du dossier dans le `context` et le `build`, code raccourcis).

```yaml
version: '3.8'

services:
  db:
    image: mysql
    ...

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ...
    
	next:
	    build:
	      context: nextjs # nom du dossier de votre app Next.js
	    volumes:
	      - ./nextjs:/app # nom du dossier de votre app Next.js
	    ports:
	      - "3000:3000"
```

Cette configuration n‚Äôa pas pour but d‚Äôindiquer comment cr√©er l‚Äôimage custom, c‚Äôest le r√¥le du Dockerfile. Elle indique √† Docker de cr√©er un conteneur bas√© sur une image, d√©fini dans le param√®tre `build` qui re√ßoit le chemin du dossier contenant le Dockerfile √† cr√©er, ici `nextjs`, qui est le nom du dossier de l‚Äôapplication Next.js.

On retrouve un param√®tre `volumes` qui va permettre de cr√©er le volume comme il vous a √©t√© indiqu√© lors de la d√©couverte du [Dockerfile](https://www.notion.so/Dockerfile-1942080267e5806d8738d4cd76215141?pvs=21) . 

Il faut donc indiquer le nom du dossier dont on souhaite persister le contenu, ici le dossier `nextjs`, ainsi que sa destination dans le conteneur, ici le dossier app.

## Ex√©cuter l‚Äôenvironnement Docker-compose

---

Voir [Commandes Docker](https://www.notion.so/Commandes-Docker-1942080267e580cf9fe2ca889fa99713?pvs=21) pour une liste plus compl√®tes des commandes Docker disponibles. Ici nous n‚Äôexploiterons que le n√©cessaire pour d√©marrer l‚Äôenvironnement pr√©c√©demment configur√©.

```bash
docker-compose up # pour d√©marrer les containers
docker-compose stop # pour arr√™ter les containers
docker-compose down # pour arr√™ter et supprimer les containers
```

Vous rencontrerez peut-√™tre (sans doute) l‚Äôerreur `Error starting userland proxy: listen tcp4 0.0.0.0:3306: bind: address already in use`. 

Cela est d√ª au fait que les services exploit√©s dans les conteneurs, ici MySQL, utilisent les m√™mes ports que ceux de votre machine. Le service MySQL de votre machine est sans doute en route et exploite le port 3306, cela provoque un conflit lorsque Docker essaie de mapper le port 3306 du service MySQL du conteneur avec le port 3306 de votre machine, d√©j√† exploit√©.

Pour cela il est n√©cessaire de conna√Ætre les commandes suivantes (Linux, valable pour tous les services MySQL, Apache‚Ä¶) :

```bash
sudo service mysql stop # Arr√™te le service local MySQL
sudo service mysql start # D√©marre le service local MySQL
sudo service mysql restart # Red√©marre le service local MySQL 
```

Si vous utilisez WAMP ou quelque chose de similaire, √©teignez le.

Si l‚Äôex√©cution du container c‚Äôest bien d√©roul√© vous pouvez dor√©navant acc√©der au container MySQL.

```bash
docker-compose exec <nom_du_container> bash # acc√©der √† un container bash
docker-compose exec <nom_du_container> sh # acc√©der √† un container sh

docker-compose exec db bash # pour notre exemple
```

Vous voila dans le container MySQL que vous avez cr√©√© et d√©marr√©, celui-ci contient le logiciel de gestion de base de donn√©es SQL MySQL. 

Pour acc√©der au serveur de base de donn√©es la d√©marche est la m√™me que sur n‚Äôimporte quelle machine.

```bash
mysql -u <nom_utilisateur> -p # acc√©der √† MySQL avec un utilisateur + mdp

mysql -u admin -proot # pour notre exemple
```